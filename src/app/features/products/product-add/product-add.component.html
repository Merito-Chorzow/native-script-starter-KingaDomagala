<ActionBar [title]="isEditMode ? 'Edytuj produkt' : 'Dodaj produkt'" class="action-bar">
  <NavigationButton
    text="Anuluj"
    android.systemIcon="ic_menu_close_clear_cancel"
    (tap)="onCancel()"
  ></NavigationButton>
</ActionBar>

<GridLayout rows="*, auto" class="page">
  <!-- Loading -->
  <ActivityIndicator
    row="0"
    *ngIf="isLoading"
    busy="true"
    class="activity-indicator"
  ></ActivityIndicator>

  <!-- Form -->
  <ScrollView row="0" *ngIf="!isLoading">
    <StackLayout class="form-container">
      <!-- Image Section -->
      <StackLayout class="image-section">
        <StackLayout class="image-preview" (tap)="onTakePhoto()">
          <!-- New captured image (ImageSource object) -->
          <Image
            *ngIf="capturedImageSource"
            [src]="capturedImageSource"
            class="preview-image"
            stretch="aspectFill"
          ></Image>
          <!-- Existing image URL (base64 data URL from storage) -->
          <Image
            *ngIf="!capturedImageSource && capturedImagePath"
            [src]="capturedImagePath"
            class="preview-image"
            stretch="aspectFill"
          ></Image>
          <!-- Placeholder when no image -->
          <StackLayout *ngIf="!capturedImageSource && !capturedImagePath" class="image-placeholder">
            <Label text="ðŸ“·" class="placeholder-icon"></Label>
            <Label text="Dotknij, aby dodaÄ‡ zdjÄ™cie" class="placeholder-text"></Label>
          </StackLayout>
        </StackLayout>
        <Button text="ðŸ“¸ ZrÃ³b zdjÄ™cie" class="photo-btn" (tap)="onTakePhoto()"></Button>
      </StackLayout>

      <!-- Form Fields -->
      <StackLayout class="form-section">
        <!-- Name Field -->
        <StackLayout class="form-field">
          <Label text="Nazwa produktu *" class="field-label"></Label>
          <TextField
            [ngModel]="productForm.get('name')?.value"
            (ngModelChange)="productForm.get('name')?.setValue($event)"
            (blur)="productForm.get('name')?.markAsTouched()"
            hint="np. Laptop Dell XPS 15"
            class="field-input"
            [class.field-error]="isFieldInvalid('name')"
            returnKeyType="next"
          ></TextField>
          <Label *ngIf="nameError" [text]="nameError" class="error-label"></Label>
        </StackLayout>

        <!-- Code Field with Scan -->
        <StackLayout class="form-field">
          <Label text="Kod produktu *" class="field-label"></Label>
          <GridLayout columns="*, auto" class="code-input-row">
            <TextField
              col="0"
              [ngModel]="productForm.get('code')?.value"
              (ngModelChange)="productForm.get('code')?.setValue($event)"
              (blur)="productForm.get('code')?.markAsTouched()"
              hint="np. DELL-XPS-15-2024"
              class="field-input"
              [class.field-error]="isFieldInvalid('code')"
              autocapitalizationType="allCharacters"
              returnKeyType="next"
            ></TextField>
            <Button col="1" text="ðŸ“· Skanuj" class="scan-btn" (tap)="onScanCode()"></Button>
          </GridLayout>
          <Label *ngIf="codeError" [text]="codeError" class="error-label"></Label>
        </StackLayout>

        <!-- Category Field -->
        <StackLayout class="form-field">
          <Label text="Kategoria *" class="field-label"></Label>
          <ListPicker
            [items]="categories"
            [selectedIndex]="categories.indexOf(productForm.get('category')?.value) >= 0 ? categories.indexOf(productForm.get('category')?.value) : 0"
            (selectedIndexChange)="productForm.get('category')?.setValue(categories[$event.value])"
            class="category-picker"
          ></ListPicker>
          <Label *ngIf="categoryError" [text]="categoryError" class="error-label"></Label>
        </StackLayout>

        <!-- Quantity Field -->
        <StackLayout class="form-field">
          <Label text="IloÅ›Ä‡ *" class="field-label"></Label>
          <GridLayout columns="auto, *, auto" class="quantity-input">
            <Button
              col="0"
              text="-"
              class="quantity-btn"
              (tap)="productForm.get('quantity')?.setValue(Math.max(0, (productForm.get('quantity')?.value || 0) - 1))"
            ></Button>
            <TextField
              col="1"
              [ngModel]="productForm.get('quantity')?.value"
              (ngModelChange)="productForm.get('quantity')?.setValue($event)"
              (blur)="productForm.get('quantity')?.markAsTouched()"
              keyboardType="number"
              class="quantity-field"
              [class.field-error]="isFieldInvalid('quantity')"
            ></TextField>
            <Button
              col="2"
              text="+"
              class="quantity-btn"
              (tap)="productForm.get('quantity')?.setValue((productForm.get('quantity')?.value || 0) + 1)"
            ></Button>
          </GridLayout>
          <Label *ngIf="quantityError" [text]="quantityError" class="error-label"></Label>
        </StackLayout>

        <!-- Description Field -->
        <StackLayout class="form-field">
          <Label text="Opis" class="field-label"></Label>
          <TextView
            [ngModel]="productForm.get('description')?.value"
            (ngModelChange)="productForm.get('description')?.setValue($event)"
            (blur)="productForm.get('description')?.markAsTouched()"
            hint="Opcjonalny opis produktu..."
            class="field-textarea"
            [class.field-error]="isFieldInvalid('description')"
          ></TextView>
          <Label *ngIf="descriptionError" [text]="descriptionError" class="error-label"></Label>
          <Label
            [text]="(productForm.get('description')?.value?.length || 0) + '/500'"
            class="char-counter"
          ></Label>
        </StackLayout>
      </StackLayout>

      <!-- Native Feature Info -->
      <StackLayout class="info-section">
        <Label text="â„¹ï¸ Funkcje natywne" class="info-title"></Label>
        <Label
          text="â€¢ UÅ¼yj przycisku 'Skanuj' aby zeskanowaÄ‡ kod produktu aparatem"
          class="info-text"
          textWrap="true"
        ></Label>
        <Label
          text="â€¢ Dotknij obszar zdjÄ™cia aby wykonaÄ‡ fotografiÄ™ produktu"
          class="info-text"
          textWrap="true"
        ></Label>
      </StackLayout>
    </StackLayout>
  </ScrollView>

  <!-- Bottom Actions -->
  <GridLayout row="1" columns="*, *" class="bottom-actions">
    <Button col="0" text="Anuluj" class="cancel-btn" (tap)="onCancel()"></Button>
    <Button
      col="1"
      [text]="isSaving ? 'Zapisywanie...' : (isEditMode ? 'Zapisz zmiany' : 'Dodaj produkt')"
      class="submit-btn"
      [isEnabled]="!isSaving"
      (tap)="onSubmit()"
    ></Button>
  </GridLayout>
</GridLayout>

